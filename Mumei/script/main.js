var rf = (function(){
  return window.requestAnimationFrame       ||
      window.webkitRequestAnimationFrame ||
      window.mozRequestAnimationFrame    ||
      window.oRequestAnimationFrame      ||
      window.msRequestAnimationFrame     ||
      function(cb){
          window.setTimeout(cb, 1000 / 60);
      };
})();

var fileSource=	[{ src:'content/sprite.png', tag:"set" }];

//sprite definitions
//to save k's using 8x8px sprites that are scaled up by 4 in game
var spriteDef = {
	'selfie':{ tag:"set", src:[{x:32,y:0}],w:16,h:16},
	'tile0':{ tag:"set", src:[{x:0,y:32}],w:8,h:8},
	'tile1':{ tag:"set", src:[{x:8,y:32}],w:8,h:8},
	'tile2':{ tag:"set", src:[{x:16,y:32}],w:8,h:8},
	'tile3':{ tag:"set", src:[{x:24,y:32}],w:8,h:8},
	'tile4':{ tag:"set", src:[{x:0,y:32}],w:8,h:8},
	'tile5':{ tag:"set", src:[{x:32,y:16}],w:8,h:8},
	'tile6':{ tag:"set", src:[{x:40,y:16}],w:8,h:8},
	'tile7':{ tag:"set", src:[{x:32,y:24}],w:8,h:8},
	'like':{ tag:"set", src:[{x:40,y:24}],w:8,h:8},
	'nolike':{ tag:"set", src:[{x:32,y:32}],w:8,h:8},
	'playeru':{ tag:"set", src:[{x:16,y:0},{x:24,y:0}],w:8,h:8},
	'playerd':{ tag:"set", src:[{x:0,y:0},{x:8,y:0}],w:8,h:8},
	'shopru':{ tag:"set", src:[{x:16,y:24},{x:24,y:24}],w:8,h:8},
	'shoprd':{ tag:"set", src:[{x:0,y:24},{x:8,y:24}],w:8,h:8},
	'trollu':{ tag:"set", src:[{x:16,y:8},{x:24,y:8}],w:8,h:8},
	'trolld':{ tag:"set", src:[{x:0,y:8},{x:8,y:8}],w:8,h:8},
	'hateru':{ tag:"set", src:[{x:16,y:16},{x:24,y:16}],w:8,h:8},
	'haterd':{ tag:"set", src:[{x:0,y:16},{x:8,y:16}],w:8,h:8}
};

var lastTime;
var now;
var dt = 0;
var fps = 60;
var step = 1 / fps;

var Renderer = new Rendering();
var game;
var Asset;

//map
var map = {
			set:'tile',
			dimensions:{width:40, height:45},
			tile:{width:32, height:32},
			screen:{width:25, height:19},
			colliders:{hit:[2,3,4,5,6,7],over:[]},
			data:[
				4,4,4,4,4,4,4,4,4,4,4,4,5,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,2,6,6,6,6,6,2,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				6,6,6,6,6,6,6,6,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,2,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,2,6,6,6,6,6,2,0,0,0,4,
				6,6,6,6,6,6,6,6,6,6,6,6,2,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,6,6,6,6,6,2,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,1,0,0,0,0,3,0,0,0,0,1,0,0,0,2,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				6,6,6,6,6,6,6,6,6,6,6,6,2,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,2,6,6,6,6,6,2,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,6,6,6,6,6,2,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,2,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,4,
				6,6,6,2,0,0,0,2,6,6,6,6,2,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,2,6,6,6,6,6,2,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				6,6,6,6,6,6,6,6,2,0,0,0,0,2,6,6,6,6,6,6,6,6,6,6,6,6,2,0,0,0,0,2,6,6,6,6,6,6,6,6,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,
				4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4	
			]
		};

/*****************************/

function Start(canvasBody)
{	
	// Create the canvas
	var canvas = document.createElement("canvas");
	if(canvas.getContext)
	{
		var ctx = canvas.getContext("2d");
		canvas.width = (map.screen.width * map.tile.width)-12;
		canvas.height = (map.screen.height * map.tile.height)-16;

		var b = document.getElementById(canvasBody);
    	b.appendChild(canvas);			

		Renderer.Init(
			{
				context:ctx, 
				spritesheet:fileSource,
				spriteData:spriteDef,
				onReady:init
			}
		);		
	}
}

function init()
{  
	game = new Watashi(map);
	Asset = game;

    var now = timestamp();	
    lastTime = now;
	FixedLoop();  
}

function FixedLoop(){
	now = timestamp();
	dt = dt + Math.min(1, (now - lastTime) / 1000);
	while (dt > step) {
	  dt = dt - step;
	  update(step);
	}

	render();

	lastTime = now;
	rf(FixedLoop);
}

function timestamp() {
	return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
}

// Update game objects
function update(dt) {
	Asset.update(dt);
};

function render() {
	Asset.render();
};

window.onload = function() {
	Start("canvasBody");
}
